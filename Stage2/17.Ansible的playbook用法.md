# Ansible的playbook用法

##### Playbook使用YAML语法

一个playbook下可以有多个play

一个play下可以有多个task

一个task下可以有多个module

例如：

```yaml
# 第一层：Playbook 开始（列表项）
- name: 部署 Nginx 服务器             # 一个 Play 的开始
  hosts: web_servers                # 作用于哪些机器
  become: yes                        # 是否提权

  # 第二层：Play 的属性
  vars:
    http_port: 80

  # 第三层：任务列表
  tasks:
    - name: 安装 Nginx               # 这是一个具体的 Task
      yum:                           # 第四层：调用 yum 模块
        name: nginx                  # 模块参数
        state: present

    - name: 启动服务                  # 又一个 Task
      service:                       # 第四层：调用 service 模块
        name: nginx
        state: started
```

#### 创建文件

```yaml
- name: 在web01上创建a.txt
  hosts: web01
  tasks:
	- name: touch a.txt
	  file:
		owner: root
		group: root
		mode: 0644
		state: touch
```

#### 复制文件到目标主机

```yaml
- name: 复制文件
  hosts: web01
  tasks:
    - name: copy hosts
      copy:
      	src: /etc/hosts
      	dest: /root/
      	owner: root
      	group: root
      	mode: 0600
```

#### 创建虚拟用户

```yaml
- name: 创建虚拟用户
  hosts: web01
  tasks:
    - name: create group
      group:
        name: oldboy
        gid: 777
        state: present
        
    - name: create user
      user:
        name: oldboy
        uid: 777
        group: oldboy
        shell: /sbin/nologin
        create_home: false
        state: present
```

#### 删除用户

```yaml
- name: 删除用户
  hosts: web01
  tasks:
    - name: delete user
        user: oldboy
        state: absent
        remove: yes
```

### 数据库相关的操作

```yaml
- name: 导出数据库
  community.mysql.mysql_db:
    state: dump
    name: my_db
    target: /tmp/my_db_backup.sql
    login_user: root
    login_password: "your_password"
```

```yaml
- name: 导入数据库
  community.mysql.mysql_db:
    state: import
    name: my_db
    target: /tmp/my_db_backup.sql
    login_user: root
    login_password: "your_password"
```

### AnsiblePlaybook重构Wordpress

可以利用AnsiblePlaybook一键部署

- 基础环境
- 应用技术栈
- 业务引入

#### WEB服务器上安装nginx

```yaml
- hosts: webs
  tasks:
    - name: Create Base Repository
      ansible.builtin.yum_repository:
        name: nginx
        description: nginx-stable
        baseurl:
          - http://nginx.org/packages/centos/7/$basearch/
        gpgcheck: no
        enabled: yes

    - name: Install Nginx Server
      ansible.builtin.yum:
        name:
          - nginx
        state: present

    - name: Configure Nginx Server
      ansible.builtin.copy:
        src: /root/ansible/webs_server/nginx/nginx.conf
        dest: /det/nginx/nginx.conf

    - name: Create User www
      ansible.builtin.user:
        name: www
        shell: /sbin/nologin
        create_home: false

    - name: Started Nginx Server
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: yes
```

#### WEB服务器上安装PHP

```yaml
- hosts: webs
  tasks:
    - name: Install PHP Server
      ansible.builtin.yum:
        name:
          - php
          - php-bcmath
          - php-cli
          - php-common
          - php-devel
          - php-embedded
          - php-fpm
          - php-gd
          - php-intl
          - php-mbstring
          - php-mysqlnd
          - php-opcache
          - php-pdo
          - php-process
          - php-xml
          - php-json
        state: present

    - name: Configure PHP Server
      ansible.builtin.copy:
        src: /root/ansible/webs_server/php/www.conf
        dest: /etc/php-fpm.d/www.conf

    - name: Start PHP Server
      ansible.builtin.systemd:
        name: php-fpm
        state: started
        enabled: yes

```

#### 安装MySQL并导入数据库

```yaml
- hosts: db02
  tasks:
    - name: Install Mariadb Server
      ansible.builtin.yum:
        name:
          - mariadb-server
          - python3-mysqlclient
        state: present

    - name: Start Mariadb Server
      ansible.builtin.systemd:
        name: mariadb
        state: started
        enabled: yes

    - name: Copy all.sql
      ansible.builtin.copy:
        src: all.sql
        dest: /root/all.sq;

    - name: import all.sql to db01
      ansible.builtin.mysql_db:
        target: /root/all.sq
        name: all
        state: import

    - name: Restart Mariadb Server
      ansible.builtin.systemd:
        name: mariadb
        state: restarted

```

#### 下载并安装wordpress（安装完成才能部署）

```yaml
- hosts: webs
  tasks:
    - name: Configure wordpress
      ansible.builtin.copy:
        src: /root/ansible/webs_server/nginx/conf.d/wp.conf
        dest: /etc/nginx/conf.d/wp.conf

    - name: Create Code dir
      ansible.builtin.file:
        path: /code/
        state: directory

    - name: unpackage wordpress
      ansible.builtin.unarchive:
        src: code/wp.tar.gz
        dest: /code/
        creates: /code/woredpress

    - name: modify owner
      ansible.builtin.file:
        path: /code/woredpress
        owner: www
        group: www
        recurse: yes

    - name: Restart Nginx Server
      ansible.builtin.systemd:
        name: nginx
        state: restarted
```

# 练手用清理主机环境
