# Iptables防火墙

iptables的层级

| **Netfilter** | **表（tables）** | **链（chains）** | **规则（Policy）**   |
| ------------- | ---------------- | ---------------- | -------------------- |
| 一栋楼        | 楼里的房子       | 房子里的柜子     | 柜子里衣服，摆放规则 |

![image-20210622185131729](file:///E:/BaiduNetdiskDownload/iptables/%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2-iptables%E9%98%B2%E7%81%AB%E5%A2%99.assets/image-20210622185131729.png)

![image-20210622185322871](file:///E:/BaiduNetdiskDownload/iptables/%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2-iptables%E9%98%B2%E7%81%AB%E5%A2%99.assets/image-20210622185322871.png)![image-20210621200719418](file:///E:/BaiduNetdiskDownload/iptables/%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2-iptables%E9%98%B2%E7%81%AB%E5%A2%99.assets/image-20210621200719418.png)![image-20210621200848162](file:///E:/BaiduNetdiskDownload/iptables/%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2-iptables%E9%98%B2%E7%81%AB%E5%A2%99.assets/image-20210621200848162.png)![image-20210621200927495](file:///E:/BaiduNetdiskDownload/iptables/%E8%80%81%E7%94%B7%E5%AD%A9%E6%95%99%E8%82%B2-iptables%E9%98%B2%E7%81%AB%E5%A2%99.assets/image-20210621200927495.png)

iptables需要了解的是4表5链

4表：filter表、nat表、raw表、mangle表

5链：PREROUTING、INPUT、FORWARD、OUTPUT、POSTROUTING

## 关于表的说明

| **表 (Table)** | **职责 (Responsibility)** | **常见用途**                                                 |
| -------------- | ------------------------- | ------------------------------------------------------------ |
| **filter**     | **过滤**                  | 最常用的表，决定包是放行（ACCEPT）还是丢弃（DROP）。         |
| **nat**        | **地址转换**              | 修改源 IP (SNAT) 或目的 IP (DNAT)，用于上网共享或端口映射。  |
| **mangle**     | **拆解报文**              | 修改数据包的特定标志位（如 TTL, TOS, Mark），用于流量整形。  |
| **raw**        | **原始状态**              | 决定数据包是否跳过状态跟踪（Connection Tracking），提高极高性能。 |

## 关于链的说明

1. **PREROUTING**: 数据包刚到达网卡，还没决定去向（是进本机还是转发）。
2. **INPUT**: 确定数据包是发给本机的。
3. **FORWARD**: 数据包不是发给本机的，需要经由本机转发到其他设备。
4. **OUTPUT**: 本机进程产生的向外发送的数据包。
5. **POSTROUTING**: 数据包即将离开网卡，发往网络。

## iptables的使用

### 安装iptables

```bash
yum -y install iptables-services
```

将防火墙相关模块加载到内核中（我也没看懂）

```bash
cat >>/etc/rc.local<<EOF
modprobe ip_tables
modprobe iptable_filter
modprobe iptable_nat
modprobe ip_conntrack
modprobe ip_conntrack_ftp
modprobe ip_nat_ftp
modprobe ipt_state  
EOF
```

总之安装好了以后可以使用systemctl命令进行启动和配置开机自启

```bash
systemctl start iptables.service
systemctl enable iptables.service
```

### iptables的命令参数

| 参数           | 含义                                          |
| -------------- | --------------------------------------------- |
| -**L**         | **显示表中的所有规则**                        |
| **-n**         | **不要把端口 或ip反向解析为 名字**            |
| **-t**         | **指定表 不指定默认是filter表**               |
| -A             | **append** 追加 加入准许类规则 使用-A         |
| -D             | delete 删除 -D INPUT 1                        |
| -I             | insert 拒绝类规则放在所有规则最上面 拒绝类 -I |
| --line-numbers | 显示行号                                      |

| 参数        | 含义                                                   |
| ----------- | ------------------------------------------------------ |
| -p          | 协议 protocal **tcp**/udp/icmp/all                     |
| **--dport** | **目标端口** dest destination 指定端口 加上协议 -p tcp |
| --sport     | 源端口 source 源                                       |
| -s          | **--source 源ip**                                      |
| -d          | --destination 目标ip                                   |
| -m          | 指定模块 multiport，需要指定这个模块才能匹配多个端口   |
| -i          | input 输入的时候 从哪个网卡进来                        |
| -o          | ouput 输出的时候 从哪个网卡出去                        |

| 参数 | 含义                                                         |
| ---- | ------------------------------------------------------------ |
| -j   | 满足条件后的动作 : **DROP/ACCEPT**/REJECT                    |
|      | DROP REJECT拒绝 <br />DROP把数据丢掉 不会返回信息给用户 <br />REJECT 拒绝 返回拒绝信息 |
|      |                                                              |

| 参数     | 含义                                             |
| -------- | ------------------------------------------------ |
| -F flush | **清除所有规则，不会处理默认的规则**             |
| -X       | 删除用户**自定义的链**                           |
| -Z       | 链的计数器清零（数据包计数器与数据包字节计数器） |

## iptables配置filter表规则

在学习环境中可以清空规则

```bash
iptables -F
iptables -X
iptables -Z
```

使用iptables查看规则

```bash
iptables -nL		# 默认表为filter，所以可以不使用-t filter
```

查看行号

```bash
iptables -nL --line-numbers
```

### 如何添加规则

```bash
iptables -t filter -A INPUT -p imcp -s IP_number -j ACCEPT/DROP/REJECT
-t	指定容器
-A	添加到链表尾部
-I	插入到链表表头
-p	协议
-s	指定IP
-j	jump跳转，其实这里是指定动作
```



### 删除规则的2种方式

以下是一个例子

```bash
[root@m01 ~]#iptables -nL --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    ACCEPT     all  --  10.0.0.0/24          0.0.0.0/0           
2    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0           
3    ACCEPT     all  --  172.16.1.0/24        0.0.0.0/0           
4    ACCEPT     tcp  --  0.0.0.0/0            0.0.0.0/0            multiport dports 80,443

Chain FORWARD (policy ACCEPT)
num  target     prot opt source               destination         

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination         
1    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0
```

通过序号删除

```bash
#以上语句中，如果我想要删除第一行规则，通过序号删除的语句如下
iptables -t filter -D INPUT 1
```

通过语句删除

```bash
#以上语句中，如果我想要删除第一行规则，通过语句删除的语句如下
iptables -t fileter -D INPUT -s 10.0.0.0/24 -j ACCEPT
```

### 屏蔽某个IP

```bash
iptables -I INPUT -s 10.0.0.9 -j DROP
-s 指定ip
```

### 禁止网段连入

```bash
iptables -I INPUT -s 10.0.0.0/24 -p tcp --dport 8888 -j DROP
--dport指定端口号
```

### 只允许指定网段连入

方法一：在默认允许的情况下

> [!NOTE]
>
> 除了10.0.0段以外的所有网络都不允许连入（也就是只有10网段可以连入）

```bash
iptables -I INPUT ! -s 10.0.0.0/24 -j DROP
```

方法二：设置默认拒绝，然后允许某些网段可以连入

```bash
iptables -t filter -P INPUT DROP
-P	我个人的理解是，指定policy，也就是指定策略
-p	小p是protocol协议啦
```

### 指定多个端口

```bash
iptables -I INPUT -p tcp --dport 8888 -j DROP
iptables -I INPUT -p tcp --dport 9999 -j DROP
```

```bash
iptables -I INPUT -p tcp -m multiport ! --dport 80,443 -j DROP
这里使用了','逗号，分别指定端口号，或者可以使用':'分号来指定连续的端口号
iptables -I INPUT -p tcp --dport 1024:65535 -j DROP
```

### 匹配ICMP类型（其实就是指定协议）

通过防火墙的方式禁止其他主机ping本机

> [!NOTE]
>
> ICMP(Internet Control Message Protocol) Internet控制报文协议，也就是ping啦

```bash
itables -I INPUT -p icmp --icmp-type 8 -j DROP
```

通过内核参数控制是否允许其他主机ping本机

```bash
vim /etc/sysctl.conf
net.ipv4.icmp_echo_ignore_all = 1	# 原文件中没有这一条,添加上这一条
sysctl -p		# 刷新内核参数
```

或者

> [!TIP]
>
> /proc/sys/net/ipv4/icmp_echo_ignore_all这个文件中的值为0

```bash
echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_all
```

### 匹配网络状态

> [!NOTE]
>
> NEW: 已经或将启动新的连接
>
> ESTABLISHED: 已建立的连接
>
> RELATED: 正在启动的新连接
>
> INVALIDE: 非法或无法识别的

```bash
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m state --state ESABLISHED,RELATED -j ACCEPT
```

### 防火墙规则的保存与恢复

```bash
iptables-save # 输出到屏幕，可以配合'>'输出到文件中，一半输出到/etc/sysconfig/iptables中
```

```bash
iptables-restore < /etc/sysconfig/iptables # 从文件中恢复到内存
```

或者可以通过

```bash
systemctl restart iptables.service	# 读取/etc/sysconfig/iptables 中的内容
```

## iptables配置nat表规则

### 实现共享上网

> [!NOTE]
>
> 将172.16.1.0网段的包的源IP，设置为本机IP，然后进行出网

```bash
# 这一种适用于公网IP会变化的情况
iptables -t nat -A POSTROUTING -s 172.16.1.0/24 -j MASQUERADE
# 这一种适合公网IP不变的情况
iptables -t nat -A POSTROUTING -s 172.16.1.9 -j SNAT --to-source 10.0.0.81
```

```bash
# 开启转发
echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf
# 刷新sysctl.conf
sysctl -p
```

> [!CAUTION]
>
> 在本案例中，需要将内网主机网卡(ens36)的GATEWAY(网关)设置为172.16.1.61

### 实现端口转发

> [!NOTE]
>
> 通过81的9000端口，转发的172.16.1.9的22端口

```bash
iptables -t nat -A PREROUTING -d 10.0.0.81 -p tcp --dport 9000 -j DNAT --to-destination 172.16.1.9:22
```

### 实现IP映射

> [!NOTE]
>
> 将外网访问的10.0.0.62转发的172.16.1.9

```bash
ip a add 10.0.0.81/24 dev eth0 label eth0:0
iptables -t nat -A PREROUTING -d 10.0.0.62 -j DNAT --to-destination 172.16.1.9
```

