# Ansible的When判断

Ansible中，可以使用when判断，如果符合条件则执行

```yaml
- hosts: webs
  tasks:
    - name: Install wget
      yum:
        name: wget
        state: present
      when: ansible_hostname == "web01"		# 当主机名为web01时则执行这一条task
```

## When中的And与Or

```yaml
- hosts: webs
  tasks:
    - name: Install wget
      yum:
        name: wget
        state: present
      when: (ansible_hostname == "web01") and (ansible_default_ipv4.address == "10.0.0.7")		# 主机名为web01并且ipv4地址为……时则执行
```

##### And的另一种写法

```yaml
- hosts: webs
  tasks:
    - name: Install wget
      yum:
        name: wget
        state: present
      when: 
        - ansible_hostname == "web01"
        - ansible_default_ipv4.address == "10.0.0.7"
```

##### When中的Or

```yaml
- hosts: webs
  tasks:
    - name: Install wget
      yum:
        name: wget
        state: present
      when: ( ansible_hostname == "web01") or (ansible_default_ipv4.address == "10.0.0.8")			# 主机名为web01或者ipv4地址为……则执行
```

### Ansible中的匹配

```tex
== 完全匹配
is match 从头匹配
is search 包含匹配
```



## Hanlders

话不多说上代码，这里以配置安装Nginx服务为例

```yaml
- hosts: web02
  tasks:
  	# 配置Nginx仓库
    - name: Configure Nginx repo
      ansible.builtin.yum_repository:
        name: nginx
        description: Nginx YUM repo
        baseurl: http://nginx.org/packages/centos/7/$basearch/
        gpgcheck: no
        enabled: true
    
    # 安装Nginx
    - name: Install Nginx Server
      ansible.builtin.yum:
        name: nginx
        state: present

	# 创建user
    - name: Create user www
      ansible.builtin.user:
        name: www
        shell: /sbin/nologin
        create_home: false

	# 配置Nginx服务
    - name: Configure Nginx Server
      ansible.builtin.copy:
        src: /root/ansible/webs_server/nginx/nginx.conf
        dest: /etc/nginx/nginx.conf
      notify: Restart Nginx Server	# 如果产生变化则交给Handler模块处理

	# 变量注册获取nginx -t指令的执行结果
    - name: Get nginx_result
      ansible.builtin.command: nginx -t
      register: nginx_result
      ignore_errors: true	# 忽略错误导致的ansible终止

	# 无论如何都启动服务
    - name: Start Nginx Server
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

  handlers:
   - name: Restart Nginx Server		# 这里的值需要与上文相同
     ansible.builtin.systemd:
       name: nginx
       state: restarted
       enabled: true
     when: nginx_result.rc in ("0")		# 如果Nginx服务产生了变化（上文），并且返回的执行结果的.rc中的值为0（执行成功）则执行
```

## playbook的循环

基础循环在前面的已经写过了，这里只贴出字典循环

> [!IMPORTANT]
>
> item中的键值对与loop中的一 一对应

```yaml
- hosts: web02
  tasks:
    - name: copy a.txt to /root, b.txt to /opt
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
      loop:
        - { src: a.txt, dest: /root, owner: root, group: root, mode: '0644'}
        - { src: b.txt, dest: /opt, owner: www, group: www, mode: '0600'}
```

## playbook的任务标签

playbook可以通过指令决定**执行**或者**跳过**带有标签的task

```yaml
- hosts: web02
  tasks:
    - name: Configure Nginx repo
      ansible.builtin.yum_repository:
        name: nginx
        description: Nginx YUM repo
        baseurl: http://nginx.org/packages/centos/7/$basearch/
        gpgcheck: no
        enabled: true
    
    - name: Install Nginx Server
      ansible.builtin.yum:
        name: nginx
        state: present

    - name: Create user www
      ansible.builtin.user:
        name: www
        shell: /sbin/nologin
        create_home: false

    - name: Configure Nginx Server
      ansible.builtin.copy:
        src: /root/ansible/webs_server/nginx/nginx.conf
        dest: /etc/nginx/nginx.conf
      notify: Restart Nginx Server
      tags: config		# 这里携带了标签config

    - name: Get nginx_result
      ansible.builtin.command: nginx -t
      register: nginx_result
      ignore_errors: true
      tags: config		# 这里也携带了标签config

    - name: Start Nginx Server
      ansible.builtin.systemd:
        name: nginx
        state: started
        enabled: true

  handlers:
   - name: Restart Nginx Server
     ansible.builtin.systemd:
       name: nginx
       state: restarted
       enabled: true
     when: nginx_result.stderr is search "successful"
```

可以使用指令**查看**标签

```bash
ansible-playbook when_tags.yml --list-tags # 查看标签
ansible-playbook when_tags.yml -t config # 执行带有config标签的task
ansible-playbook when_tags.yml --skip-tags config # 跳过带有config标签的task
```

## 使用include实现ansible文件复用

分别写2个task，然后整合进一个playbook中使用

```yaml
- name: Install Nginx server
  ansible.builtin.yum:
    name: nginx
    state: present
```

```yaml
- name: Install nfs server
  ansible.builtin.yum:
    name: nfs-utils
    state: present
```

整合

```yaml
- hosts: webs
  tasks:
    - name: Install Nginx
      ansible.builtin.include_tasks: nginx_install.yml
      when: ansible_hostname in ("web01")
    - name: Install nfs Server
      ansible.builtin.include_tasks: nfs_install.yml
      when: ansible_hostname in ("nfs")
```

## 数据纠偏

当使用查询相关配置是否正确时，例如nginx -t，我们希望查询成功返回的是ok而不是changed

可以使用changed_when: false将changed纠正为ok

例如：

```yaml
- name: Get nginx_result
  ansible.builtin.command: nginx -t
  register: nginx_result
  ignore_errors: true
  tags: config
  changed_when: false
```

## jinjx2中的for循环与if判断

### for循环

当我们配置负载均衡时，需要在Nginx配置文件中写入负载均衡要转发到的多台服务器的地址，这时候需要使用for循环

```jinja2
upstream {{ server_name }} {
{% for n in range(7,9) %}		# 这里使用的for循环
    server 172.16.1.{{ n }}:{{ up_port }};
{% endfor %}
}

server {
    listen 80;
    server_name {{ server_name }}

    location / {
        root /code;
        index index html;
        proxy_pass http://{{ server_name }}
        proxy_set_header Host $http_host;
    }
}
```

而我们需要在对应的yml中写入参数

```yaml
- hosts: web02
  vars:
    - server_name: www.wp.com
    - up_port: 8080
  tasks:
    - name: copy lb.conf to web02
      ansible.builtin.template:
        src: lb.conf.j2
        dest: /root/lb.conf
```

### if判断

在配置负载均衡时，根据主机的不同，会分配不同的权重，这时候可以使用if判断将master主机与其他backup主机区分开来（下面的例子甚至不需要定义变量）

```jinja2
global_defs {
    router_id {{ ansible_hostname }}
}

vrrp_instance VI_1 {
{% if ansible_fqdn == "web01" %}		# 这里使用了if判断
    state MASTER
    priority 150
{% else %}
    state BACKUP
    priority 100
{% endif %}

    interface ens33
    virtual_router_id 50
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.3
    }
}
```

```yaml
- hosts: webs
  tasks:
    - name: copy keepalived.conf.j2 to web02
      ansible.builtin.template:
        src: keepalived.conf.j2
        dest: /root/keepalived.conf
```

# Roles角色

这里需要先创建一个roles文件夹，然后在里面ansible-galaxy init 角色名来初始化一个角色

```bash
mkdir -p /root/ansible/roles
cd /root/ansible/roles
ansible-galaxy init backup		# 这里以backup为例
```



handles中的main.yml文件

```yaml
---
# handlers file for backup
- name: Restart Rsync Server
  ansible.builtin.systemd:
    name: rsyncd
    state: restarted
```

tasks中的main.yml文件

```yaml
---
# tasks file for backup
- name: Install Rsync Server
  ansible.builtin.yum:
    name: rsync
    state: present

- name: Configure Rsync Server
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  notify: Restart Rsync Server
  loop:
    - { src: rsyncd.conf.j2, dest: /root/rsyncd.conf, mode: '0644' }
    - { src: rsync.passwd, dest: /root/rsync.passwd, mode: '0600' }

- name: Create user
  ansible.builtin.user:
    name: "{{ user }}"
    shell: /sbin/nologin
    create_home: false

- name: Create "{{ code_dir }}"
  ansible.builtin.file:
    path: "{{ code_dir }}"
    state: directory
    owner: "{{ user }}"
    group: "{{ user }}"

- name: Start backup Server
  ansible.builtin.systemd:
    name: rsyncd
    state: started
    enabled: true
```

templates模板文件夹中的rsync.passwd与rsyncd.conf.j2

```tex
rsync_backup:123
```

```jinja2
uid = {{ user }}
gid = {{ user }}
port = {{ port }}
fake super = yes
use chroot = no
max connections =200
timeout = 600
ignore errors
read only = false
list = falseauth users = rsync_backup
secrets file = /etc/rsync.passwd
log file = /var/log/rsyncd.log
#####################################
[backup]
comment = welcome to oldboyedu backup!
path = {{ code_dir }}
```

vars文件夹中的main.yml

```yaml
---
# vars file for backup
user: www
port: 873
code_dir: /backup
```

最后必须在roles中写一个backup.yml来启动backup角色

```yaml
- name: backup
  hosts: bak
  roles:
    - backup		# 这里必须使用列表
```

最后的文件目录是这样的

```bash
[root@m01 roles]#tree ./
./
├── backup
│   ├── defaults
│   │   └── main.yml
│   ├── files
│   ├── handlers
│   │   └── main.yml
│   ├── meta
│   │   └── main.yml
│   ├── README.md
│   ├── tasks
│   │   └── main.yml
│   ├── templates
│   │   ├── rsyncd.conf.j2
│   │   └── rsync.passwd
│   ├── tests
│   │   ├── inventory
│   │   └── test.yml
│   └── vars
│       └── main.yml
└── backup.yml
```