# 前后端分离

##### 技术框架

```tex
核心框架：SpringBoot 2.0.0
持久层框架：Mybatis 1.3.2
日志管理：SLF4J 1.7
前端框架：Vue 2.7.16
UI框架: Ant-Design-Vue 1.5.2
模板框架: Jeecg-Boot 2.2.0
项目管理框架: Maven 3.3.9
```

##### 服务器环境

```tex
数据库：Mysql8.0.24
JAVA平台：JRE1.8
Redis库：redis6.2.1
Nginx代理：nginx1.12.2
操作系统：Windows、Linux等
```

## 业务部署

WEB01WEB02充当前端服务器、WEB03、WEB04充当后端服务器(10.0.0.7~10.0.0.10)

LB01充当前端负载、LB02充当后端负载(10.0.0.5、10.0.0.6)

DB02充当后端数据库(10.0.0.52)

### 配置DB02服务器的MySQL数据库

```bash
mkdir -p /app/tools/
```

```bash
tar xf mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz -C /app/tools/
cd /app/tools
ln -s mysql-8.0.28-linux-glibc2.12-x86_64 mysql
```

安装依赖

```bash
yum -y install ncurses ncurses-devel libaio-devel openssl openssl-devel
```

添加mysql用户

```bash
useradd -s /sbin/nologin -M mysql
```

创建配置文件

```bash
vim /etc/my.cnf
```

```tex
[mysqld]
user=mysql
basedir=/app/tools/mysql/
datadir=/app/data/3306/
port=3306


[client]
socket=/tmp/mysql.sock
```

```bash
mkdir -p /app/data/3306
```

修改目录属主属组

```bash
chown mysql.mysql /app/data/3306 /etc/my.cnf
```

设置环境变量

```bash
echo "export PATH=/app/tools/mysql/bin:$PATH" >> /etc/profile
source /etc/profile
```

初始化数据库

> [!WARNING]
>
> --initialize-insecure
>
> 以不安全的方式初始化，root为空密码，如果不指定这个选项则随机创建密码

```bash
mysqld --initialize-insecure --user=mysql --basedir=/app/tools/mysql/ --datadir=/app/data/3306
```

查看上一条命令是否运行成功，返回0则成功

```bash
echo $?
```

启动数据库配置

```bash
cp /app/tools/mysql/support-files/mysql.server /etc/init.d/mysqld
chmod +x /etc/init.d/mysqld
```

修改启动脚本

> [!TIP]
>
> -A是向下显示，-B是向上显示，-C是向上向下显示

```bash
grep -A1 ^basedir /etc/init.d/mysqld
vim /etc/init.d/mysqld
```

修改这两行的配置

```bash
46 basedir=/app/tools/mysql/
47 datadir=/app/data/3306/
```

创建数据库

```bash
mysql
```

> [!NOTE]
>
> 设定远程用户exam可以由172.16.1网段的任意主机登录，密码为1
>

```mysql
create user exam@'172.16.1.%' identified with mysql_native_password by '1';
```

> [!NOTE]
>
> 给来自172.16.1网段的exam用户授权操作exam库下的所有表的权限（如果\*.\*就是所有数据库的所有表的权限）

```mysql
grant all on exam.* to exam@'172.16.1.%';
```

用 exam用户测试登录MySQL数据库

```bash
mysql -uexam -p1 ph 172.16.1.52
```

将上传的.sql文件导入到exam库

```bash
mysql exam < xzs-mysql.sql
```

### 在同一台服务器上配置前端与后端

#### 配置后端

需要准备一台WEB03

安装Java环境

```bash
yum -y install java
```

创建目录

```bash
mkdir -p /app/code/exam/{backend,frontend}
cd /app/code/exam/backend
```

上传jar包与yml配置文件

```tex
application-prod.yml
xzs-3.9.0.jar
```

yml配置文件的内容

```yaml
#server后端服务的配置
server:
  port: 8000
  undertow:
    io-threads: 16
    worker-threads: 4000
    buffer-size: 1024
    direct-buffers: true
  compression:
    enabled: true
    min-response-size: 1
#日志
logging:
  path: /app/code/exam/backend/

#数据库,redis等等配置
spring:
  datasource:
    #mysql://数据库地址:端口号/库名字?
    url: jdbc:mysql://172.16.1.52:3306/exam?useSSL=false&useUnicode=true&serverTimezone=Asia/Shanghai&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&allowPublicKeyRetrieval=true&allowMultiQueries=true
    username: exam
    password: 1
    driver-class-name: com.mysql.cj.jdbc.Driver
```

在backend中启动jar包

> [!TIP]
>
> 可以使用nohup…………&挂到后台运行

```bash
java -Duser.timezone=Asia/Shanghai -jar -Dspring.profiles.active=prod xzs-3.9.0.jar
```

直接连接http://10.0.0.9:8000/和http://10.0.0.9:8000/admin进行测试

#### 配置前端服务器

配置Nginx库，并安装Nginx

```bash
vim /etc/yum.repos.d/nginx.repo
```

```bash
[nginx-stable]
name=nginx stable repo
baseurl=https://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
```

```bash
yum -y install nginx
```

配置转发到后端的server

```bash
vim /etc/nginx/conf/exam.conf
```

```nginx
server {
    listen 80;
    server_name admin.oldboy.com;
    root /app/code/exam/frontend/admin/;

    location / {
        index index.html;
    }
    location /api {
        proxy_pass http://localhost:8000;
    }
}

server {
    listen 80;
    server_name stu.oldboy.com;
    root /app/code/exam/frontend/student/;

    location / {
        index index.html;
    }
    location /api {
        proxy_pass http://localhost:8000;
    }
}
```

检查Nginx的语法并重启

```bash
nginx -t
systemctl start nginx
```

将前端zip包上传至/app/code/exam/frontend/

```bash
cd /app/code/exam/frontend
```

上传后

```bash
unzip exam-web-前端.zip
mv exam-web-前端/* .
```

host解析并访问10.0.0.9 admin.oldboy.com stu.oldboy.com

## 集群部署

#### 扩展后端服务器

扩展一台WEB04，安装Java， 拷贝代码，启动后端服务

```bash
# web04中
yum -y install java
# web03中
scp -r /app/ 10.0.0.10:/
# web04中
cd /app/code/exam/backend/
nohup java -Duser.timezone=Asia/Shanghai -jar -Dspring.profiles.active=prod xzs-3.9.0.jar &
```

访问测试http://10.0.0.10:8000/

#### 后端的四层转发

使用LB02负责后端负载，配置4层代理

```bash
vim /etc/nginx/nginx.conf
```

```nginx
...
# 写在http块之外
stream {
    upstream exam {
        10.0.0.9:8000;
        10.0.0.10:8000;
        hash $remote_addr consistent;	# 没有使用Redis保持会话一致，这里开启了会话黏滞
    }
    server {
        listen 8000;
        proxy_pass exam;
    }
}
...
```

#### 配置前端服务器

WEB01上要做的事

```bash
vim /etc/nginx/conf/exam.conf
```

```nginx
server {
    listen 80;
    server_name admin.oldboy.com;
    root /app/code/exam/frontend/admin/;

    location / {
        index index.html;
    }
    location /api {
        proxy_pass http://10.0.0.6:8000;
    }
}

server {
    listen 80;
    server_name stu.oldboy.com;
    root /app/code/exam/frontend/student/;

    location / {
        index index.html;
    }
    location /api {
        proxy_pass http://10.0.0.6:8000;
    }
}
```

检查Nginx的语法并重启服务

```bash
nginx -t
systemctl resart nginx
```

将WEB03的前端代码拷贝至本地

```bash
scp -r 10.0.0.9:/app/ /
```

访问10.0.0.7 admin.oldboy.com stu.oldboy.com进行测试

配置WEB02与WEB01相同

WEB02上

```bash
scp 10.0.0.7:/etc/nginx/conf.d/exam.conf /etc/nginx/conf.d/
scp -r 10.0.0.7:/app/
nginx -t
systemctl restart nginx
```

#### 配置前端负载

> [!TIP]
>
> 正常情况下，因为用户通过LDNS拿到的是A记录，所以可以在前端配置4层转发，但是我们这里使用域名访问，所以还是配置7层转发

LB01充当前端负载

在LB01上

```bash
vim /etc/nginx/conf.d/exam.conf
```

```nginx
upstream exam {
    server 172.16.1.7;
    server 172.16.1.8;
}
server {
    listen 80;
    server_name admin.oldboy.com;

    location / {
        proxy_pass http://exam;
        include proxy_set;
    }
}
server {
    listen 80;
    server_name stu.oldboy.com;

    location / {
        proxy_pass http://exam;
        include proxy_set;
    }
}
```

```bash
nginx -t
systemctl restart nginx
```

DNS解析并测试访问10.0.0.5 admin.oldboy.com stu.oldboy.com







