# 如何用堡垒机配置其他服务器

### 首先在堡垒机上更改内网DNS解析

```bash
vim /etc/hosts
# 添加以下DNS解析
172.16.1.7  web01
172.16.1.8  web02
172.16.1.31 nfs
172.16.1.41 backup
```

### 创建文件夹，一个用来放配置文件，一个用来放脚本

```bash
mkdir -p /servers/scripts /servers/configurations
```

## 编写配置文件

### 编写backup上的rsync的配置文件 

```properties
vim /servers/configurations/rsyncd.conf
uid = www
gid = www
port = 873
fake super = yes
use chroot = no
max connections = 200
timeout = 600
ignore errors = yes
read only = false
list = false
auth users = backup
secrets file = /etc/rsync.passwd

[backup]
path = /backup

[nfs]
path = /backup/nfs

[web01]
path = /backup/web01

[web02]
path = /backup/web02

[data]
path = /data

```

### 编写nfs服务器上运行的lsync的配置文件

```bash
vim /servers/configurations/lsyncd.conf
```

```properties
settings {
	logfile = "/var/log/lsyncd/lsyncd.log",
	satusFile = "/var/log/lsyncd/lsyncd.status",
	maxProcesses = 2,		# 最大连接数
	nodaemon = false,		# 开启守护进程
}
sync {
	default.rsync,
	source = "/data/",
	target = "backup@backup::data",		# 主机名@地址：：模块名
	delete = true,		# 开启全量同步
	delay = 1,		# 延迟1秒推送
	rsync = {
		binary = "user/bin/rsync",		# 二进制命令文件
		password_file = "/etc/rysnc.passwd",	# 指定密码文件
		archive = true,		# 相当于-a，保留文件属性
		compress = true,		# 相当于-z，压缩
	}
}
```



## 编写服务器上执行的脚本

#### 编写WEB服务器执行备份的脚本

```bash
vim /servers/scripts/backup.sh
#!/bin/bash
#此脚本用于备份、校验、推送和清理7天文件
# 定义变量
HOST=`hostname`
IP=`hostname -I | awk '{pring $2}'`
TIME=`date +%F`
DIR=${HOST}_${IP}_${TIME}
# 创建打包目录和校验文件目录
mkdir -p /backup/$HOST/
# 打包文件到以上目录
tar -zcvf /backup/$HOST/$DIR.tar.gz -C /etc hosts passwd
# 用md5文件进行校验
md5sum /backup/$HOST/$DIR.tar.gz > /backup/$HOST/$DIR.tar.gz.md5
# 推送到backup
rsync -avz /backup/$HOST/ backup@backup::$HOST --password-file=/etc/rsync.passwd 
# 清理7天文件
find /backup/$HOST/ -mtime +7 | xargs rm -rf

```

#### 编写backup服务器执行校验、发送邮件、清理6个月文件的脚本

```bash
vim /servers/scripts/md5check.sh
#!/bin/bash
# 定义校验文件存放路径
RESULT=/servers/log/md5/`date +%F`.log
# 创建存放md5校验文件的文件夹
mkdir -p /servers/log/md5/
# 用于md5校验备份的文件
find /backup/ -name "*.md5" | xargs md5sum -c > $RESULT
# 将校验结果发送给邮箱
# mail -s check_result 1329488086@qq.com < $RESULT
# 服务端保留6个月内的备份文件
find /backup/ -type f -mtime +`expr 6 \* 30` | xargs rm -rf
```



## 编写本地脚本

#### 编写backup的执行脚本

```bash
vim /servers/scripts/backup_server.sh
#!/bin/bash
# 这是在远程连接到backup服务器上执行的脚本
# 远程发送DNS解析、rsync配置文件和校验脚本
ssh backup 'mkdir -p /servers/scripts'
scp /etc/hosts backup:/etc/
scp /servers/configurations/rsyncd.conf backup:/etc/
scp /servers/scripts/md5check.sh backup:/servers/scripts
# 连接backup服务器,进行SSH远程执行
ssh backup << EOF
# 安装相应服务
yum -y install rsync
yum -y install nfs-utils
# yum -y install mailx sendmail
# 创建虚拟用户
useradd -s /sbin/nologin -M www
# 写入密码配置文件
echo backup:123 > /etc/rsync.passwd
echo '/data 172.16.1.0/24(rw,sync,all_squash)' > /etc/exports
# 密码文件权限更改为600
chmod 600 /etc/rsync.passwd
# 创建文件夹并更改属主属组
mkdir -p /backup/web{01..02} /backup/nfs /data
chown -R www.www /backup /data
# 启动rsyncd服务
systemctl start rsyncd
systemctl enable rsyncd
# 启动nfs服务
systemctl start nfs
systemctl enable nfs
# 设置定时任务执行MD5校验
echo '00 01 * * * sh /servers/scripts/md5check.sh &> /dev/null' >> /var/spool/cron/root
EOF


```



#### 编写nfs的执行脚本

```bash
vim /servers/scripts/nfs_server.sh
#!/bin/bash
# 这是远程连接到nfs服务器上执行的脚本
# 发送lsync配置文件和备份脚本
ssh nfs 'mkdir -p /servers/scripts'
scp /etc/hosts nfs:/etc/
scp /servers/configurations/lsyncd.conf nfs:/etc
scp /servers/scripts/backup.sh nfs:/servers/scripts/
# 连接nfs服务器,进行SSH远程执行
ssh nfs << EOF
# 安装相应服务
yum -y install rsync
yum -y install nfs-utils
yum -y install lsyncd
# 创建用户
useradd -s /sbin/nologin -M www
# 配置共享文件夹
echo '/data 172.16.1.0/24(rw,sync,all_squash)' > /etc/exports
# 创建文件更改属主属组
mkdir /data
chown www.www /data
# 启动nfs服务
systemctl start nfs
systemctl enable nfs
# 设置定时任务执行备份
echo '00 01 * * * sh /servers/scripts/backup.sh &> /dev/null' >> /var/spool/cron/root
EOF

```



#### 编写web01的执行脚本

```bash
vim /servers/scripts/web01_server.sh
#!/bin/bash
# 这是远程连接到web01上的执行脚本
# 远程发送DNS解析配置文件和备份脚本
ssh web01 'mkdir -p /servers/scripts/'
scp /etc/hosts web01:/etc/
scp /servers/scripts/backup.sh web01:/servers/scripts/
# 连接web01服务器，,进行SSH远程执行
ssh web01 << EOF
# 安装远程nfs服务
yum -y install nfs-utils
# 将nfs服务器的/data文件夹挂载到/mnt
mount -t nfs nfs:/data /mnt
echo 'nfs:/data		/mnt		nfs		default		0	0' >> /etc/fstab
# 设置定时任务执行备份
echo '00 01 * * * sh /servers/sciprts/backup.sh &> /dev/null' >> /var/spool/cron/root
EOF

```

#### 编写web02的执行脚本

```bash
vim /servers/scripts/web02_server.sh
#!/bin/bash
# 这是远程连接到web01上的执行脚本
# 远程发送DNS解析配置文件和备份脚本
ssh web02 'mkdir -p /servers/scripts/'
scp /etc/hosts web02:/etc
scp /servers/scripts/backup.sh web02:/servers/scripts/
# 连接web02服务器，,进行SSH远程执行
ssh web02 << EOF
# 安装远程nfs服务
yum -y install nfs-utils
# 将nfs服务器的/data文件夹挂载到/mnt
mount -t nfs nfs:/data /mnt
echo 'nfs:/data		/mnt		nfs		default		0	0' >> /etc/fstab
# 设置定时任务执行备份
echo '00 01 * * * sh /servers/sciprts/backup.sh &> /dev/null' >> /var/spool/cron/root
EOF

```

# 将几个脚本整合到一起

```bash
vim /servers/scripts/bastion.sh
#!/bin/bash
# 备份服务器脚本
sh /servers/scripts/backup_server.sh
# nfs服务器脚本
sh /servers/scripts/nfs_server.sh
# web01服务器脚本
sh /servers/scripts/web01_server.sh
# web02服务器脚本
sh /servers/scripts/web02_server.sh
```

