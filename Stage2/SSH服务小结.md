# SSH服务小结

SSH相较于Telnet的优势，是在通信过程中保持了加密，从而避免了明文传输

### 查看SSH服务是否开启

一般来说，可以通过Shell软件连接的服务器都安装了ssh服务

> [!NOTE]
>
> sshd
>
> **S**ecure **Sh**ell **D**aemon
>
> 这里的d是daemon，即**守护进程**，其他相似的结尾带d的服务与之类似

```bash
systemctl status sshd
```

> [!NOTE]
>
> SSH服务的默认端口是22

```bash
netstat -tnulp
```

| 文件路径             | 作用                                                         | 存放内容                                                     | 关键配置项                                                   |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| /etc/ssh/sshd_config | SSh服务器主配置文件。控制SSH服务端的行为，影响服务器上的所有用户。 | 包含服务的全局设置，如监听端口、允许的认证方式、root登录权限等。 | Port22<br />PasswordAuthentication no<br />PermitRootLogin no |
| /etc/ssh/ssh_config  | SSH客户端主配置文件。控制服务器上所有用户在使用ssh连接其他机器时的默认性微温 | 包含连接远程主机的默认参数。                                 | Host *<br />StricHostKeyChecking yes                         |



### SSH服务的配置文件

```bash
cat /etc/ssh/sshd_config
```

##### SSH需要优化的配置

```bash
Port 22						# 可能根据需要修改端口号
PasswordAuthentication no	# 为了安全可能需要禁用密码登录验证，使用密钥验证
GSSAPIAuthentication no		# 禁用单点登录验证，加快登录速度
UseDNS no					# 根据IP反向解析域名，再对域名正向DNS查询A记录
```



#####  SSH服务的公钥、私钥以及认证指纹

| 文件名称        | 角色                          | 存放内容                                                 | 用途                                                         |
| --------------- | ----------------------------- | -------------------------------------------------------- | ------------------------------------------------------------ |
| id_rsa          | 用户的私钥<br />(Private Key) | 加密的私钥数据。必须**严格保密**                         | 客户端用于验明身份，解密服务器的挑战信息。                   |
| id_rsa.pub      | 用户的公钥<br />(Public Key)  | 纯文本格式的公钥数据。可公开分享                         | 客户端用于发布身份，服务器用于加密挑战数据。                 |
| authorized_keys | 已授权的公钥列表              | 一行一个，包含所有允许登录到该账户的远程用户的公钥内容。 | 服务器段检查客户提供的私钥是否匹配该文件中的任何公钥。这是实现密钥登录的核心文件。 |
| known_hosts     | 已知的主机指纹                | 记录了所有已连接过的远程服务器的公钥指纹                 | 客户端用于验证远程服务器的身份。如果服务器指纹发生变化（可能被中间人攻击），SSH会发出警告。 |

### SSH命令

> [!NOTE]
>
> 语法格式:
>
> ​	ssh 用户名@主机

```bash
ssh		# 固定命令、
用户名		# 指定用户名，如果不指定则以当前用户身份进行连接
@		# 指定分隔符
主机		# IP地址、域名、主机名称
例如:
ssh root@10.0.0.41

Window中，指定端口号的格式是空格
ssh root@10.0.0.41 2222

Linux中，指定端口号需要-p参数
-p port 指定端口号
ssh root@172.16.1.41 -p2222
```

##### 远程执行命令

> [!NOTE]
>
> 语法格式：
>
> ​	ssh (用户名)(@)主机名 “执行的命令”
>
> 括号中的内容可以省略

```
例如
ssh root@172.16.1.41 'touch a.txt'
```

### SSH免密钥

#### 在本地生成一对公钥与私钥

```bash
ssh-keygen
```

公钥存放在/root.ssh/id_rsa中

私钥存放在/root.ssh/id_rsa.pub中

#### 将公钥发送给目标主机 

```bash
ssh-copy-id 目标主机地址
```

#### 切换到目标主机

```bash
cat .ssh/authorized_keys	#可以查看本地其他主机的公钥
```

#### 完成以上步骤，即可将主机的PasswordAuthentication关闭

```bash
vim /etc/ssh/sshd_cofig
...找到66行
PasswordAuthentication no	#把yes改为no
```

可以实现通过密钥而不通过密码远程连接

> [!TIP]
>
> Authentication	认证
>
> Authorization	授权

# SCP远程拷贝

> [!TIP]
>
> 与rsync增量拷贝不同，SCP为全量拷贝

#### 语法和使用

与CP相似

```bash
scp 本地文件夹 目标主机:/目标文件夹 
scp 目标主机:/目标文件夹 本地文件夹
```

> [!NOTE]
>
> 参数 -r 递归

```bash
scp -r #递归，拷贝该目录以及目录下的所有文件
```

> [!NOTE]
>
> 参数 -P 指定端口号

> [!CAUTION]
>
> 注意⚠️：这里的P是大写

```bash
scp -P 端口号 本地文件夹 目标主机:/目标文件夹

举例
scp -P2222 /etc/passwd 172.16.1.41:/opt/
	某个端口号被改为2222的主机
```

