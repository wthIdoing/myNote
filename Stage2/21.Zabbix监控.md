# Zabbix监控

## Zabbix的部署

需要准备：

克隆一台虚拟机，IP10.0.0.71，主机名zabbix

zabbix-5.0.47.tar.gz

mysql-8.0.36-1.el8.x86_64.rpm-bundle.tar

MySQL的下载地址在这里
https://downloads.mysql.com/archives/community/

将文件上传到虚拟机后，解压压缩包

```bash
tar -xf zabbix-5.0.47.tar.gz
tar -xf mysql-8.0.36-1.el8.x86_64.rpm-bundle.tar
```

### 数据库的安装

安装MySQL的各项依赖

```bash
# ls  egrep '*.rpm$' | xargs rpm -ivh  这个不用
rpm -ivh mysql-community-common-8.0.36-1.el8.x86_64.rpm 
rpm -ivh mysql-community-client-plugins-8.0.36-1.el8.x86_64.rpm 
rpm -ivh mysql-community-libs-8.0.36-1.el8.x86_64.rpm 
rpm -ivh mysql-community-client-8.0.36-1.el8.x86_64.rpm 
rpm -ivh mysql-community-icu-data-files-8.0.36-1.el8.x86_64.rpm 
rpm -ivh mysql-community-devel-8.0.36-1.el8.x86_64.rpm 
rpm -ivh mysql-community-server-8.0.36-1.el8.x86_64.rpm 
```

安装完成以后启动数据库

```bash
systemctl start mysqld
systemctl enable mysqld
```

进入/var/log/mysqld.log查看随机生成的密码

```bash
cat /var/log/mysqld.log | grep root@local
```

比如我这里的生成结果是

```bash
[root@zabbix ~]#cat /var/log/mysqld.log  | grep root@local
2026-01-14T11:09:54.511055Z 6 [Note] [MY-010454] [Server] A temporary password is generated for root@localhost: 48O:dkcPrmR>
```

其中密码是48O:dkcPrmR>

> [!WARNING]
>
> 虽然root@localhost: 48O:dkcPrmR>中间有空格，但是这里的空格不算密码
>
> 而且在Linux界面中，O与0很像，不要搞混了

进入MySQL库修改密码

```bash
mysql -uroot -p'48O:dkcPrmR>'
```

```mysql
ALTER USER root@localhost IDENTIFIED BY 'Oldboy123.com';
```

> [!IMPORTANT]
>
> 这里要复杂密码，否则提示ERROR 1819 (HY000): Your password does not satisfy the current policy requirements

创建zabbix库

```mysql
CREATE DATABASE zabbix CHARACTER SET utf8 COLLATE utf8_bin;
```

创建zabbix用户

```mysql
CREATE USER 'zabbix'@'localhost' IDENTIFIED BY 'Oldboy123.com';
```

修改zabbix用户密码

```mysql
ALTER USER 'zabbix'@'localhost' IDENTIFIED WITH mysql_native_password BY 'Oldboy123.com';
```

给zabbix用户授权

```mysql
GRANT ALL PRIVILEGES ON zabbix.* to 'zabbix'@'localhost';
```


### PHP服务的部署

```bash
yum -y install php php-bcmath php-cli php-common php-devel php-embedded php-fpm php-gd php-intl php-mbstring php-mysqlnd php-opcache php-pdo php-process php-xml php-json php-ldap
```

安装好以后修改/etc/php-fpm.d/www.conf配置文件

```bash
vim /etc/php-fpm.d/www.conf
```

将监听端口改为本机的9000

```properties
39:listen = 127.0.0.1:9000
```

记得检查一下端口

```bash
netstat -tunlp
```

### Nginx服务的部署

> [!NOTE]
>
> 学过以前的流程的都知道，是经典流程了

```bash
vim /etc/yum.repos.d/nginx.repo
```

```properties
[nginx-stable]
name=nginx stable repo
baseurl=http://nginx.org/packages/centos/7/$basearch/
gpgcheck=0
enabled=1
gpgkey=https://nginx.org/keys/nginx_signing.key
module_hotfixes=true
```

```bash
yum -y install nginx
```

> [!NOTE]
>
> 但是这里不一样，需要添加zabbix的配置

```bash
vim /etc/nginx/conf.d/default.conf
```

```nginx
server {
    listen 80;
    server_name  _;
    root /code;
    index index.php index.html;
    location ~ \.php$ {
        fastcgi_pass   
            127.0.0.1:9000;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME 
            $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```

记得检查一下语法

```bash
nginx -t
```

启动并设置成开机自己，记得检查一下端口是否启动了

```bash
systemctl start nginx
systemctl enable nginx
netstat -tunlp
```

将zabbix中的代码拷贝的/code目录

```bash
mkdir /code
cd /code/
cp -r /root/zabbix-5.0.41/ui/* .
```

并且将代码目录属主属组改为apache

```bash
chown -R apache.apache /code/
```

将nginx.conf中的nginx启动用户改为apache

```bash
vim /etc/nginx/nginx.conf
```

总之是第1行

```nginx
user  apache;
```

### Zabbix的安装

先进入到源码的数据库目录

```bash
cd zabbix-5.0.47/database/mysql/
```

将schema.sql images.sql data.sql导入到创建好的zabbix库

```bash
mysql -uzabbix -p'Oldboy123.com' zabbix < schema.sql
mysql -uzabbix -p'Oldboy123.com' zabbix < images.sql
mysql -uzabbix -p'Oldboy123.com' zabbix < data.sql
```

进入到zabbix源码目录

```bash
cd zabbix-5.0.47/
```

安装依赖包

```bash
yum -y install libxml2 libxml2-devel net-snmp-devel curl-devel libevent-devel
```

配置zabbix

```bash
./configure --enable-server --enable-agent --with-mysql --enable-ipv6 --with-net-snmp --with-libcurl --with-libxml2
make && make install
```

配置zabbix连接数据库的信息

```bash
vim /usr/local/etc/zabbix_server.conf
```

```properties
94:DBName=zabbix
110:DBUser=zabbix
120:DBPassword=Oldboy123.com
```

添加zabbix启动用户

```bash
useradd zabbix -s /sbin/nologin -M
```

编写systemctl运行zabbix

```bash
vim /usr/lib/systemd/system/zabbix.service
```

```ini
[Unit]
Description=Zabbix server
After=network.target

[Service]
Type=forking
ExecStart=/usr/local/sbin/zabbix_server
ExecStop=/usr/local/sbin/zabbix_server stop
User=zabbix
Group=zabbix

[Install]
WantedBy=nulti-user.target
```

重新加载配置

```bash
systemctl daemon-reload
```

启动服务

```bash
systemctl start zabbix
systemctl enable zabbix
```

检查一下端口10051是否启动

```bash
netstat -tunlp
```

接下来用浏览器登录到10.0.0.71在界面部署zabbix

![image-20260114205011956](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114205011956.png)

需要修改默认的PHP设置

```bash
vim /etc/php.ini
```

```ini
383:max_execution_time = 300
393:max_input_time = 300
672:post_max_size = 16M
902:date.timezone = Asia/Shanghai
```

测试php语法

```bash
php-fpm -t
```

重启php服务

```bash
systemctl restart php-fpm
```

继续部署

这里的user是启动用户，也就是创建出来的zabbix，密码是设置的数据库用户zabbix的密码Oldboy123.com

![image-20260114205609962](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114205609962.png)

这里需要输入主机的名称，我们已经设置好了主机名为zabbix，就填写zabbix

![image-20260114205734468](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114205734468.png)

部署完成后就可以登录了，账户是Admin，密码是zabbix

#### 修改语言

**在左下角的User Settings中，可以将语言修改为中文**

#### 修改字体

将Windows宿主机的C:\Windows\fonts目录下的中文字体取出

替换掉Linux中的/code/assets/fonts

先将/code/assets/fonts移动为备份

```bash
mv DejaVuSans.ttf DejaVuSans.ttf.bak
```

我这里使用的是微软雅黑的常规字体

将msyh.tcc复制进去后，改名为DejaVuSans.ttf

```bash
mv msyh.ttc DejaVuSans.ttf
```

将nginx、php-fpm、zabbix全都重启一遍，刚刚遇到了卡死的问题，重启就好了（虽然最后重启的是nginx）

> [!CAUTION]
>
> 刚刚是启动了服务端，现在需要启动客户端

```bash
zabbix_agentd
```

### 目标主机的监控

需要在目标主机上安装一个zabbix-agent客户端

```bash
yum -y install zabbix-agent
```

将zabbix客户端配置文件指向服务端172.16.1.71

```bash
vim /etc/zabbix_agentd.conf
```

```ini
115:Server=172.16.1.71
```

启动并开机自启

```bash
systemctl start zabbix-agent
systemctl enable zabbix-agent
```

然后返回到zabbix的页面添加主机

![image-20260114214157635](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114214157635.png)

![image-20260114214232372](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114214232372.png)

![image-20260114214304145](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114214304145.png)

![image-20260114214324176](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114214324176.png)

![image-20260114214343425](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114214343425.png)

**日志的位置**

服务端日志在/tmp/zabbix_server.log

客户端日志在/var/log/zabbix/zabbix_agentd.log

## 自定义监控流程

例如：现在我要监控有多少个窗口正在访问我的服务器，我应该如何监控

1. 取值

   老师使用的方法是uptime | awk '{print $(NF-6)}'

   我觉得也可以who | wc -l

2. 写入客户端的配置文件

   ```bash
   vim /etc/zabbix_agent.conf
   ```

   修改UserParameter这一项

   ```ini
   338:UserParameter=user_login_number,who | wc -l
   ```

   保存退出以后可以使用以下命令检查一遍

   ```bash
   zabbix_agentd -p
   ```

3. 重启客户端

   ```bash
   systemctl restart zabbix-agent
   ```

4. 服务端检查自定义的key值是否取值成功

   ```bash
   zabbix_get -s 172.16.1.9 -k user_login_number
   ```

5. 添加到zabbix界面

![image-20260114215803413](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114215803413.png)

![image-20260114215822004](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114215822004.png)

![image-20260114220125290](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260114220125290.png)

自定义取值可以使用include方式将自定key单独存放到.conf文件中

在**客户端**的/etc/zabbix_agentd.conf中可以修改此配置

```bash
vim /etc/zabbix_agentd.conf
```

```ini
314 Include=/etc/zabbix_agentd.conf.d/*.conf
```

修改了这个配置之后，需要手动创建目录

```bash
mkdir /etc/zabbix_agentd.conf.d/
```

将自定义的监控项放入到该目录的文件中

```bash
vim /etc/zabbix_agentd.conf.d/system_diy.conf
```

```ini
UserParmeter=user_login_number, who | wc -l
```

### 监控SSH端口

按照流程，依旧先在客户端的/etc/zabbix_agentd.conf.d/system_diy.conf中添加自定义项

```ini
UserParameter=ssh_port_number,netstat -tunlp | grep 22 | grep -w tcp | wc -l
-w 完全匹配单词
```

zabbix需要获取权限才能在目标主机使用netstat命令

```bash
chmod u+s /usr/bin/netstat
```

可以在**客户端**使用以下命令进行测试

```bash
zabbix_agent -p
```

在**服务端**使用以下命令进行测试

```bash
zabbix_get -s 172.16.1.9 -k ssh_port_number
```

测试完毕以后添加到主机的监控项

![image-20260115163718801](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115163718801.png)

可以配置一个值映射，根据**不同的值**展示**不同的内容**

点击展示值映射，可以在接下来的页面中创建一个

![image-20260115164121835](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115164121835.png)

> [!TIP]
>
> 这里的意思是，当筛选出来的SSH端口（不包含监听IPV6的）有1个时，说明SSH服务正在运行。筛选不出来自然是没有运行的

![image-20260115164027425](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115164027425.png)

### 创建触发器

需要在配置主机中选择创建触发器

![image-20260115170638451](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115170638451.png)

![image-20260115170809108](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115170809108.png)

![image-20260115170905079](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115170905079.png)

![image-20260115170945503](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115170945503.png)

如果需要创建多个表达式同时符合条件的情况，需要先点击表达式构造器

![image-20260115171452216](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115171452216.png)

![image-20260115171531526](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115171531526.png)

![image-20260115171637750](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115171637750.png)

### 配置邮件告警

#### 配置告警媒介

![image-20260115172109200](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115172109200.png)

z这里需要先获取授权码
![image-20260115174509547](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115174509547.png)

![image-20260115192419811](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115192419811.png)

#### 配置动作

![image-20260115174859381](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115174859381.png)

![image-20260115175150480](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175150480.png)

![image-20260115175203760](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175203760.png)

![image-20260115175220869](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175220869.png)

这里操作与恢复操作的通知对象都是相同的
![image-20260115175358540](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175358540.png)

#### 配置收件人

![image-20260115175557365](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175557365.png)

![image-20260115175615528](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175615528.png)

发送到自己的邮箱

![image-20260115175651536](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175651536.png)

#### 配置自定义消息模板

![image-20260115175819493](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175819493.png)

![image-20260115175841807](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115175841807.png)

```tex
默认标题
故障: {EVENT.NAME}
消息内容: 
报警主机: {HOST.NAME1}
报警服务: {ITEM.NAME}
报警key1: {ITEM.KEY1}: {ITEM.VALUE1}
报警key2: {ITEM.KEY2}: {ITEM.VALUE2}
严重级别: {TRIGGER.SEVERITY}

恢复操作
恢复: {EVENT.NAME}
消息内容:
恢复主机: {HOST.NAME1}
恢复服务: {ITEM.NAME}
恢复key1: {ITEM.KEY1}: {ITEM.VALUE1}
恢复key2: {ITEM.KEY2}: {ITEM.VALUE2}
```

### 配置远程执行命令

用Nginx宕机再由zabbix拉起举例

先监听Nginx端口

**配置监控项**

![image-20260115194104480](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115194104480.png)

这里有官方自带的监听的键值，将[]中的port换成你想监听的端口

![image-20260115194148847](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115194148847.png)

**配置触发器**

![image-20260115194748193](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115194748193.png)

zabbix在客户端上执行命令需要sudo提权，所以

```bash
visudo
```

在最后一行加上

```ini
zabbix ALL=(ALL) NOPASSWD: ALL
```

还需要在客户端上开启远程执行命令的功能

```bash
vim /etc/zabbix_agentd.conf
```

```ini
91 EnableRemoteCommands=1
```

配置完需要重启zabbix-agent

```bash
systemctl restart zabbix-agent
```

![image-20260115195536816](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115195536816.png)

## 自定义图形

![image-20260115200552731](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115200552731.png)

![image-20260115200618314](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115200618314.png)

![image-20260115201842142](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115201842142.png)

![image-20260115202022175](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115202022175.png)

这一块就是刚刚添加的图形了

![image-20260115202133057](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115202133057.png)

### 聚合图形

报错

```tex
[15-Jan-2026 20:58:54 Asia/ShangHai] PHP Fatal error:  Uncaught ArgumentCountError: array_merge() does not accept unknown named parameters in /code/include/classes/macros/CMacrosResolver.php:2018

Stack trace:

#0 /code/include/classes/macros/CMacrosResolver.php(2018): array_merge(label: Array, urls: Array)

#1 [internal function]: CMacrosResolver->{closure}(Array)

#2 /code/include/classes/macros/CMacrosResolver.php(2019): array_map(Object(Closure), Array)

#3 /code/include/classes/macros/CMacrosResolverHelper.php(565): CMacrosResolver->resolveMacrosInMapElements(Array, Array)

#4 /code/include/classes/helpers/CMapHelper.php(103): CMacrosResolverHelper::resolveMacrosInMapElements(Array, Array)

#5 /code/include/classes/screens/CScreenMap.php(36): CMapHelper::get('1', Array)

#6 /code/include/classes/screens/CScreenBuilder.php(487): CScreenMap->get()

#7 /code/include/views/monitoring.screen.php(146): CScreenBuilder->show()

#8 /code/include/classes/mvc/CView.php(122): include('/code/include/v...')

#9 /code/screens.php(164): CView->getOutput()

#10 {main}

  thrown in /code/include/classes/macros/CMacrosResolver.php on line 2018
```



![image-20260115211736187](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115211736187.png)

![image-20260115211645231](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115211645231.png)

##### 1. 为什么这行代码在 PHP 8.0 会报错？

这涉及到 PHP 8.0 的一个重大变化：**具名参数 (Named Arguments)**。

- **代码逻辑**：这行代码的意思是将 `$macros_by_location` 这个数组里的子数组全部合并。

- **报错原因**：在 PHP 7.x 中，`call_user_func_array` 会忽略数组的**字符串键名**。但在 PHP 8.0 中，如果 `$macros_by_location` 数组带有字符串键名（比如 `'label' => [...]`），PHP 会尝试把这些键名当作 `array_merge` 函数的参数名。

- **矛盾点**：`array_merge` 函数并不支持具名参数，于是 PHP 就抛出了 `ArgumentCountError` 异常，导致了你看到的 500 错误。

##### 2. 应该怎么修改？

  要修复这个 Bug，最简单的办法是**强制去掉数组的字符串键名**，只保留数据内容，让 PHP 认为这只是普通的参数列表。

  请将第 2018 行修改为以下代码（**建议先备份原文件**）：

  **修改前：**

  PHP

  ```
  return array_keys(array_flip(call_user_func_array('array_merge', $macros_by_location)));
  ```

  **修改后（方案一：使用 array_values 过滤键名）：**

  PHP

  ```
  return array_keys(array_flip(call_user_func_array('array_merge', array_values($macros_by_location))));
  ```

  **或者（方案二：使用 PHP 8 的新语法 `...` 运算符，更简洁）：**

  PHP

  ```
  return array_keys(array_flip(array_merge(...array_values($macros_by_location))));
  ```

  **修改逻辑解析：** 我们加上了 `array_values()` 函数。它的作用是丢弃原数组中所有的字符串键名（如 `label` 等），只留下纯粹的数据。这样 `array_merge` 拿到的就是干净的数据序列，不再会去匹配参数名，程序就能正常运行了。



总之创建聚合图形

![image-20260115212827106](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115212827106.png)

![image-20260115212917634](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115212917634.png)

![image-20260115212939732](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115212939732.png)

![image-20260115212951287](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115212951287.png)

自己改就好了

![image-20260115213321575](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115213321575.png)

创建好了也不会有确认/添加按钮，直接回退就可以看了

### 创建幻灯片

在聚合图形中创建幻灯片

![image-20260115214230612](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115214230612.png)

右上角创建幻灯片播放

![image-20260115214252380](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115214252380.png)

![image-20260115214426708](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260115214426708.png)

## 自定义模板

**监控nginx七种状态**

在客户端default.conf中添加查看nginx状态的location

```nginx
location \nginx_status{
    stub_status;
}
```

检查语法并重启生效

```bashi
nginx -t
systemctl restart nginx
```

编辑与Nginx相关的监控项，将7种状态的键值对与获取方式写入

```bash
vim /etc/zabbix_agentd.conf.d/nginx_diy.conf
```

```ini
UserParameter=Active_connections,curl -s 127.0.0.1/nginx_status | awk 'NR==1{print $NF}'
UserParameter=Server_accepts,curl -s 127.0.0.1/nginx_status | awk 'NR==3{print $1}'
UserParameter=Server_handled,curl -s 127.0.0.1/nginx_status | awk 'NR==3{print $2}'
UserParameter=Server_requests,curl -s 127.0.0.1/nginx_status | awk 'NR==3{print $3}'
UserParameter=Server_reading,curl -s 127.0.0.1/nginx_status | awk 'NR==4{print $2}'
UserParameter=Server_writing,curl -s 127.0.0.1/nginx_status | awk 'NR==4{print $4}'
UserParameter=Server_waiting,curl -s 127.0.0.1/nginx_status | awk 'NR==4{print $6}'
```

在客户端使用以下命令进行测试

```bash
zabbix_agentd -p
```

在服务端使用以下命令进行测试

```bash
zabbix_get -s 172.16.1.9 -k Active_connections
```

全部配置完成后添加模板

![image-20260116145755977](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116145755977.png)

![image-20260116150009992](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116150009992.png)

点击监控项添加自定义的7个键就好了

![image-20260116150033900](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116150033900.png)

创建完的模板应该是这样的
![image-20260116155114842](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116155114842.png)

在主机的选项中关联模板

![image-20260116155356412](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116155356412.png)

关联模板后主机的监控项就会出现以上这些，这时候就可以创建图形了

选中刚刚关联的模板中的7项

![image-20260116155957322](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116155957322.png)

![image-20260116160456684](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260116160456684.png)

**监控PHP**

修改/etc/php-fpm.d/www.conf中的项

```ini
38 listen = 127.0.0.1:900
240 pm.status_path = /status
```

在/etc/nginx/conf.d/default中添加

```nginx
location /status {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}
location ~ \.php$ {
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}
```

这时只需访问10.0.0.9/status即可访问到php的status，添加自定义监控流程与Nginx流程相同。

## 使用脚本方式自定义监控项

使用case脚本传参的方式获取七种状态

在客户端上进行配置

```bash
vim /etc/zabbix_agentd.conf.d/ nginx.sh
```

```sh
#!/bin/sh
case $1 in
	Active_connections)
	curl -s 127.0.0.1/nginx_status | awk 'NR==1{print $NF}'
	;;
	Server_accepts)
	curl -s 127.0.0.1/nginx_status | awk 'NR==3{print $1}'
	;;
	Server_handled)
	curl -s 127.0.0.1/nginx_status | awk 'NR==3{print $2}'
	;;
	Server_requests)
	curl -s 127.0.0.1/nginx_status | awk 'NR==3{print $3}'
	;;
	Server_reading)
	curl -s 127.0.0.1/nginx_status | awk 'NR==4{print $2}'
	;;
	Server_writing)
	curl -s 127.0.0.1/nginx_status | awk 'NR==4{print $4}'
	;;
	Server_waiting)
	curl -s 127.0.0.1/nginx_status | awk 'NR==4{print $6}'
	;;
	*)
	echo "Usage: $0 [Active_connections|Server_accepts|Server_hanelde|Server_requests|Server_reading|Server_writing|Server_waiting]"
esac
```

给脚本执行权限

```bash
chmod +x /etc/zabbix_agentd.conf.d/nginx.sh
```

修改自定义key配置文件，也就是zabbix_agentd.conf.d/ngxin_diy.conf

```bash
UserParameter=nginx.[*],/etc/zabbix_agentd.conf.d/nginx.sh $1
```

重启生效

```bash
systemctl restart zabbix-agent
```

在服务端上进行测试

```bash
zabbix_get -s 172.16.1.9 -k nginx.[Active_connections]
```

## zabbix通过SNMP监控网络设备

SNMP介绍：

```tex
简单网络管理协议（SNMP－Simple Network Management Protocol)

SNMP的经常使用版本有三个：SNMPv1、SNMPv2、SNMPv3（SNMPv3是具备安全性的通讯协议）
SNMP被普遍应用在NMS网络管理系统中（NetworkManagement System）。知名的NMS包括BMC的
Patrol、CA的Unicenter、Sun Mangegement控制台、IBM的Tivoli Netview、以及全球著名的HP 
Openview。 NMS的目标是提供一个监控和管理全部开启SNMP功能的设备的单一入口。

SNMP协议经过UDP端口161和162进行通讯。

161端口：SNMP Message

162端口：SNMP Trap Meaasge

SNMP管理模型中有三个基本组成部分：管理站（Manager）,被管代理（Agent）和管理信息库（MIB）。

被管代理（Agent）指的是用于跟踪监测被管理设备状态的特殊软件或硬件，每个代理都拥有自己本地的MIB。
被管代理（Agent）翻译来自管理站（Manager）的请求，验证操作的可执行性，通过直接与相应的功能实体（如网络设备）通信来执行信息处理任务，同时向管理站返回响应信息。
```

网络设备硬件信息的2种表示方法

```tex
OID表示法 .1.3.6.1.2.1.25.2.2.0	# 获取内存
MIB表示法 hrMemorySize				# 获取内存
```

这个网址可以查看各种OID与MIB

https://www.cnblogs.com/cqx6388/p/17235747.html

首先在**客户端**安装snmp

```bash
yum -y install net-snmp
```

修改/etc/snmp/snmpd.conf的配置

```bash
vim /etc/snmp/snmpd.conf
```

```bash
41 com2sec notConfigUser  default       public
55 view    systemview    included   .1.
117 group   notConfigGroup  v2c             notConfigUser
```

启动snmp并查看端口161是否运行

```bash
systemctl start snmpd
netstat -tunlp
```



在**服务端**安装snmp

```bash
yum -y install net-snmp-utils
```

查看客户端名称

```bash
snmpwalk -v2c -c public 10.0.0.9 SysName
-v	指定SNMP版本
2c	指定SNMP版本为V2
-c	指定团体名称
返回结果: 
SNMPv2-MIB::sysName.0 = STRING: web01
```

```bash
snmpwalk -v2c -c public 10.0.0.9 .1.3.6.1.2.1.25.2.2.0
或者
snmpwalk -v2c -c public 10.0.0.9 hrMemorySize
返回结果:
HOST-RESOURCES-MIB::hrMemorySize.0 = INTEGER: 454812 KBytes
```

测试通过后，页面中使用snmp协议监控

将原先的Agent移除后，选择SNMP

![image-20260118160550905](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118160550905.png)

填入正确的项

![image-20260118160629255](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118160629255.png)

![image-20260118160726282](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118160726282.png)

![image-20260118160957041](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118160957041.png)

## zabbix自动化监控

配置自动发现

![image-20260118162040585](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118162040585.png)

配置动作

![image-20260118162313350](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118162313350.png)

可以在操作层面发现主机后，关联模板

![image-20260118162517081](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118162517081.png)

## 自动注册

zabbix的默认模式为：
服务端：主动模式，主动获取客户端的数据
客户端：被动模式，让服务端获取数据

首先修改客户端为主动模式

在**客户端**上

```bash
vim /etc/zabbix_agentd.conf
```

```ini
162 ServerActive=172.16.1.71	# 主动注册服务器地址
173 Hostname=web01				# 必须设置为主机名称
```

修改配置后重启

```bash
systemctl restart zabbix-agent
```

删除或者停用自动发现避免与自动注册相互冲突

![image-20260118185509687](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118185509687.png)

创建自动注册动作

![image-20260118185655635](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118185655635.png)

条件为主机名称包含web

![image-20260118185748756](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118185748756.png)

设置操作为添加主机、添加到主机群组、关联模板

![image-20260118190459731](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118190459731.png)

## 修改监控项为主动上报模式

将自动注册中的模板动作给改为主动(active)

![image-20260118192306455](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118192306455.png)

## zabbix proxy代理

这里演示的是web01作为代理，收集web02的数据

先参考Zabbix的部署，部署MySQL数据库，编译并安装zabbix

但是这里的编译安装稍有区别

```bash
./configure --prefix=/usr/ --enable-proxy --with-net-snmp --with-mysql
make && make install
```

这里只需要导入zabbix-5.0.42/database/mysql/schema.sql

```bash
cd /zabbix-5.0.43/database/mysql/
mysql -uzabbix -pOldboy123.com zabbix < schema.sql
```

修改proxy配置文件连接数据库信息

```bash
cd /usr/etc
vim zabbix_proxy.conf
30 Server=10.0.0.71
49 Hostname=sh_proxy
167 DBName=zabbix
182 DBUser=zabbix
190 DBPassword=Oldboy123.com
```

配置完成后在命令行输入

```bash
zabbix_proxy
netstat -tunlp
```

启动zabbix代理服务，查看10051端口，是否启动的是/zabbix_proxy

在web02上下载zabbix客户端

```bash
yum -y install zabbix-agent
```

修改配置文件

```bash
vim /etc/zabbix_agentd.conf
```

```ini
115 Server=172.16.1.9
161 ServerActive=172.16.1.9
172 Hostname=web02
```



在管理中添加代理

![image-20260118200735793](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118200735793.png)

![image-20260118200808902](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118200808902.png)

使用代理获取主机

![image-20260118203018880](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118203018880.png)

## 监控Java程序

zabbix通过zabbix-java-gateway实现对java的监控

监控java使用jmx协议

### 在客户端部署Java程序

在web02上传好jdk与tomcat包后

```bash
rpm -ivh jdk-8u181-linux-x64.rpm
tar xf apache-tomcat-9.0.113.tar.gz
mv apache-tomcat-9.0.113 /usr/local/tomcat
```

修改配置文件

```bash
vim /usr/local/tomcat/bin/catalina.sh 
```

在开头复制粘贴如下语句

```bash
#!/bin/sh
CATALINA_OPTS="$CATALINA_OPTS -Dcom.sun.management.jmxremote -Djava.rmi.server.hostname=10.0.0.10 -Dcom.sun.management.jmxremote.port=12345 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false"
```

启动tomcat

```bash
/usr/local/tomcat/bin/startup.sh
```

### 服务端配置Java网关

这里是在zabbix服务端上做的事

```bash
vim /usr/local/etc/zabbix_server.conf
```

```ini
293 JavaGateway=10.0.0.51
301 JavaGatewayPort=10052
309 StartJavaPollers=2
```

### 在db01安装java gateway

先安装zabbix仓库

```bash
rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-latest-5.0.el7.noarch.rpm
```

如果要在web01上安装，需要卸载web01上的客户端

> [!WARNING]
>
> 这一步是在web01上做的

```bash
yum -y remove zabbix50-agent-5.0.47
```

回到db01，需要安装Java网关

```bash
yum -y install zabbix-java-gateway
systemctl start zabbix-java-gateway.service
```

在页面配置中选择JMX

![image-20260118211049939](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118211049939.png)

模板中选择Apache Tomcat JMX

![image-20260118211139403](C:\Users\yellowsea\AppData\Roaming\Typora\typora-user-images\image-20260118211139403.png)

## zabbix优化

1. 高并发需要对MySQL进行拆分（数据库不部署在本地）
2. zabbix-agent被动上传改为主动上报模式
3. 地区较多的情况、网络复杂的情况使用proxy代理模式
4. 系统自带监控项优化
5. 进程优化
6. 缓存优化

面试题：zabbix监控过哪些内容

1. 监控主机硬件信息，比如内存、CPU、负载、磁盘IO
2. 监控系统重要的配置文件、代码，防止黑客篡改
3. 监控服务是否正常（通过调取端口号或进程号）
4. 监控服务、软件业务的状态信息（Nginx、数据库状态、增删改查、订单量、慢查询）
5. 监控业务调用接口，使用curl返回内容
6. 业务数据监控、日志监控、日志状态码、客户端IP地址

通过自定义什么都能监控

zabbix压力大如何解决？
答：被动模式改为主动上报模式

zabbix如何优化？

用过zabbix的低级自动发现吗？监听多实例
